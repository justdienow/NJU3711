# NJU3711 Arduino Library

A comprehensive, non-blocking Arduino library for the NJU3711 8-bit serial-to-parallel converter IC with specialized 7-segment display support.

[![Arduino](https://img.shields.io/badge/Arduino-Compatible-blue.svg)](https://www.arduino.cc/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

## Author

**justdienow**

> **Note:** This entire library - including all source code (NJU3711.cpp, NJU3711.h, NJU3711_7Segment.cpp/.h, NJU3711_7Segment_Multi.cpp/.h), example sketches, and comprehensive documentation suite (Getting Started, API Reference, Hardware Guide, Advanced Usage, and Troubleshooting) - was 100% generated by Claude (Anthropic). The library was created based on the NJU3711 datasheet, hardware specifications, reverse engineered PCB images, and design requirements through an iterative collaboration with Claude. <br> There will be bugs.

## Features

- **Non-blocking operation** - State machine architecture for smooth multitasking
- **Queue-based operations** - Handle multiple commands seamlessly  
- **7-segment display support** - Specialized classes with animations
- **Multi-digit displays** - Built-in multiplexing for 3-digit displays
- **Flexible pin configuration** - Software or hardware-strapped CLR control
- **Common cathode/anode support** - Works with both display types
- **Individual bit control** - Set, clear, toggle individual outputs
- **Built-in animations** - Rotating segments, loading bars, chase effects
- **Test patterns** - Easy debugging and verification

## Quick Start

```cpp
#include <NJU3711.h>

NJU3711 expander(2, 3, 4); // DATA, CLK, STB pins

void setup() {
    expander.begin();
    expander.write(0xFF); // Turn on all outputs
}

void loop() {
    expander.update(); // MUST call regularly!
}
```

## Documentation

**Complete documentation available in the `/docs` folder:**

- **[Getting Started Guide](docs/Getting_Started.md)** - Step-by-step tutorials for beginners
  - Your first LED project
  - LED bar graph
  - Single 7-segment display
  - 3-digit counter

- **[API Reference](docs/API_Reference.md)** - Complete method documentation
  - All classes and methods
  - Parameters and return values
  - Code examples

- **[Hardware Guide](docs/Hardware_Guide.md)** - Wiring and electrical specifications
  - Pin configurations
  - Wiring diagrams
  - PCB design notes
  - Power calculations

- **[Advanced Usage](docs/Advanced_Usage.md)** - Complex applications
  - Multiple devices
  - 6-digit cascaded displays
  - Digital clock project
  - Custom animations
  - Real-world applications

- **[Troubleshooting](docs/Troubleshooting.md)** - Problem solving
  - Common issues and solutions
  - Diagnostic tools
  - Quick checklist

## Hardware Support

### NJU3711 IC Specifications
- **Function:** 8-bit Serial-In, Parallel-Out Shift Register
- **Operating Voltage:** 5V ± 10%
- **Maximum Frequency:** 5MHz
- **Output Current:** 25mA per pin (can drive LEDs directly)
- **Packages:** DIP14, DMP14, SSOP14
- **Input Protection:** Hysteresis inputs (0.5V typical)

## Installation

### Arduino IDE (Recommended)

1. Download the library as a ZIP file
2. In Arduino IDE: **Sketch → Include Library → Add .ZIP Library**
3. Select the downloaded ZIP file
4. Restart Arduino IDE

### Manual Installation

1. Extract the ZIP file
2. Move the folder to your Arduino libraries directory:
   - **Windows:** `Documents\Arduino\libraries\`
   - **Mac:** `~/Documents/Arduino/libraries/`
   - **Linux:** `~/Arduino/libraries/`
3. Restart Arduino IDE

### Verify Installation

Go to **File → Examples → NJU3711** - you should see the example sketches.

## Basic Usage Examples

### Simple LED Control

```cpp
#include <NJU3711.h>

NJU3711 expander(2, 3, 4);

void setup() {
    expander.begin();
}

void loop() {
    expander.update(); // CRITICAL - call every loop!
    
    if (!expander.isBusy()) {
        expander.setBit(0);    // Turn on P1
        delay(500);
        expander.clearBit(0);  // Turn off P1
        delay(500);
    }
}
```

### 7-Segment Display

```cpp
#include <NJU3711_7Segment.h>

NJU3711_7Segment display(2, 3, 4, ACTIVE_LOW);

void setup() {
    display.begin();
}

void loop() {
    display.update(); // CRITICAL - call every loop!
    
    static int counter = 0;
    if (!display.isBusy()) {
        display.displayDigit(counter);
        counter = (counter + 1) % 10;
        delay(1000);
    }
}
```

### 3-Digit Counter

```cpp
#include <NJU3711_7Segment_Multi.h>

NJU3711_7Segment_Multi display(2, 3, 4, 5, 6, 7, ACTIVE_LOW);

void setup() {
    display.begin();
}

void loop() {
    display.update(); // CRITICAL - call every loop!
    
    static int count = 0;
    display.displayNumber(count);
    count = (count + 1) % 1000;
    delay(100);
}
```

## Pin Connections

### Basic Connection (CLR Strapped HIGH)

```
Arduino  →  NJU3711
Pin 2    →  DATA (pin 8)
Pin 3    →  CLK (pin 9)  
Pin 4    →  STB (pin 10)
5V       →  VDD (pin 14) and CLR (pin 11)
GND      →  VSS (pin 4)
```

### 7-Segment Display (Segment Mapping)

```
NJU3711  →  7-Segment Display
P8 (bit7) →  A (top)
P7 (bit6) →  F (top left)
P6 (bit5) →  B (top right)
P5 (bit4) →  G (middle)
P4 (bit3) →  E (bottom left)
P3 (bit2) →  C (bottom right)
P2 (bit1) →  D (bottom)
P1 (bit0) →  DP (decimal point)
```

**Always use 220-470Ω current-limiting resistors!**

See the [Hardware Guide](docs/Hardware_Guide.md) for complete wiring diagrams.

## Library Architecture

### Three Main Classes

1. **NJU3711** - Base class for general parallel output control
   - Direct bit manipulation
   - 8-bit parallel output
   - Test patterns

2. **NJU3711_7Segment** - Single digit 7-segment display control
   - Display digits 0-9 and hex A-F
   - Character display support
   - Built-in animations
   - Decimal point control

3. **NJU3711_7Segment_Multi** - Multi-digit display with multiplexing
   - 3-digit numeric display (0-999)
   - Automatic multiplexing
   - Individual digit control
   - Leading zero suppression

### Non-Blocking Design

All operations are **non-blocking** using a queue-based state machine:

```cpp
void loop() {
    display.update();  // Process state machine
    
    // Your code runs without blocking
    readSensors();
    checkButtons();
    updateDisplay();
}
```

**Critical Rules:**
1. Always call `update()` in your `loop()`
2. Check `isBusy()` before queuing new operations
3. Avoid using `delay()` - use `millis()` timing instead

## Examples

The library includes several example sketches:

- **NJU3711_Basic** - Basic parallel output control and LED patterns
- **NJU3711_7Segment_Single_Demo** - Single digit display with animations
- **NJU3711_Advanced** - Multiple devices and performance monitoring
- **NJU3711_7Segment_Cascade_Demo** - 6-digit cascaded display
- **NJU3711_7Segment_Cascade_Clock_Demo** - Complete digital clock (HH:MM:SS)

Access via **File → Examples → NJU3711** in Arduino IDE.

## Key Methods

### NJU3711 Class

```cpp
void begin();                              // Initialize
void update();                             // Process state machine (MUST call!)
bool write(uint8_t data);                  // Write 8-bit value
bool setBit(uint8_t pos);                  // Set individual bit
bool clearBit(uint8_t pos);                // Clear individual bit
bool toggleBit(uint8_t pos);               // Toggle individual bit
bool clear();                              // Clear all outputs
bool isBusy();                             // Check if ready
uint8_t getCurrentData();                  // Get current output value
```

### NJU3711_7Segment Class

```cpp
bool displayDigit(uint8_t digit);          // Display 0-9
bool displayHex(uint8_t value);            // Display 0-F
bool displayChar(char c);                  // Display character
bool setDecimalPoint(bool state);          // Control decimal point
bool startAnimation(AnimationType type);   // Start animation
void stopAnimation();                      // Stop animation
bool displayBlank();                       // Clear display
```

### NJU3711_7Segment_Multi Class

```cpp
bool displayNumber(uint16_t number);       // Display 0-999
void setLeadingZeros(bool enable);         // Show/hide leading zeros
void setMultiplexDelay(unsigned long us);  // Adjust brightness
bool displayError();                       // Show "Err"
bool setDigit(uint8_t pos, uint8_t val);  // Set individual digit
```

See the [API Reference](docs/API_Reference.md) for complete documentation.

## Supported Display Types

- Common Cathode 7-segment displays (ACTIVE_LOW mode)
- Common Anode 7-segment displays (ACTIVE_HIGH mode)
- Single digit displays
- Multi-digit displays (with multiplexing)
- Individual LEDs
- LED bar graphs

## Animation Types

Built-in animations for 7-segment displays:

- `ANIM_ROTATE_CW` - Clockwise segment rotation
- `ANIM_ROTATE_CCW` - Counter-clockwise rotation
- `ANIM_BLINK` - Blinking display
- `ANIM_CHASE` - Chasing segments
- `ANIM_LOADING` - Loading bar effect

```cpp
display.startAnimation(ANIM_ROTATE_CW, 200000); // 200ms delay
```

## Common Issues

### Nothing displays?
- Check power connections (VDD and VSS)
- Verify CLR pin is HIGH
- Ensure `begin()` is called in `setup()`
- Confirm `update()` is called in `loop()`

### Wrong segments light up?
- Verify your display's pinout (they vary!)
- Check display mode: `ACTIVE_LOW` vs `ACTIVE_HIGH`
- Test individual segments with test code

### Display flickers?
- Call `update()` more frequently
- Remove blocking `delay()` calls
- Reduce multiplex delay: `setMultiplexDelay(1500)`

See the [Troubleshooting Guide](docs/Troubleshooting.md) for complete solutions.

## Performance

- **Operation speed:** ~100µs per 8-bit write (at 5MHz clock)
- **Queue size:** 8 operations
- **Memory usage:** Minimal (<100 bytes per instance)
- **Multiplex rate:** ~167Hz default (3 digits @ 2ms each)

## Requirements

- **Hardware:** Arduino (Uno, Mega, Nano, etc.) or compatible
- **Software:** Arduino IDE 1.8.x or 2.x
- **Dependencies:** None (standalone library)

## Compatible Boards

- Arduino Uno / Nano / Mini
- Arduino Mega / Due
- Arduino Leonardo / Micro
- ESP8266 / ESP32 (5V level shifter recommended)
- Teensy (5V version)
- Any Arduino-compatible board with digital I/O

## Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This library is released under the MIT License. See [LICENSE](LICENSE) file for details.

## Version History

### v2.0.0 (Current)
- Added non-blocking operation with state machine architecture
- Added 7-segment display specialized class
- Added 3-digit multiplexed display class
- Added animation system
- Added support for hardware-strapped CLR pin
- Comprehensive documentation suite
- Multiple example sketches
- Bug fixes and performance improvements

### v1.0.0
- Initial blocking implementation
- Basic parallel output control

## Resources

- **NJU3711 Datasheet:** [Available in repository](docs/datasheets/)
- **Example PCB Designs:** [See Hardware Guide](docs/Hardware_Guide.md)
- **Community Projects:** [Show and Tell](https://github.com/yourusername/NJU3711/discussions)

## Safety Notice

**Important Safety Information:**

- Always use current-limiting resistors (220-470Ω) with LEDs
- Do not exceed 25mA per output pin
- Ensure proper power supply (5V ± 10%)
- Handle IC with ESD precautions
- Verify polarity before applying power

See the [Hardware Guide](docs/Hardware_Guide.md) for complete safety information.